#!/bin/bash

# create default values
MELD_ENABLE="true"
MELD_DEFAULT_STYLE_FILE="/usr/share/meld/styles/meld-base.xml"
MELD_DESTINATION_STYLE_FILE="${HOME}/.local/share/gtksourceview-3.0/styles/gcs-theme-meld.xml"

# read configuration from config file, if existing
[ -f "${CONFIG_DIR}/modules/meld" ] && source "${CONFIG_DIR}/modules/meld"

# perform operations if possible
if ! [ "${MELD_ENABLE}" == "true" ]; then
    printf "* Not setting colors for Meld (disabled from configuration).\n"
elif ! [ -f "${MELD_DEFAULT_STYLE_FILE}" ]; then
    printf "* Not setting colors for Meld (default style not found: ${MELD_DEFAULT_STYLE_FILE}).\n"
elif ! which xmlstarlet >/dev/null; then
    printf "* Not setting colors for Meld (XMLStarlet is not installed).\n"
elif [ "${editor_syntax_enable}" == "false" ]; then
    if [ "$(gsettings get org.gnome.meld style-scheme)" == "'gcs-theme'" ]; then
        gsettings set org.gnome.meld style-scheme "meld-base"
    fi
else
    printf "* Setting colors for Meld..."
    
    install -D "${MELD_DEFAULT_STYLE_FILE}" "${MELD_DESTINATION_STYLE_FILE}"
    
    xmlstarlet ed --inplace --update "/style-scheme/@id"          --value "gcs-theme"                   "${MELD_DESTINATION_STYLE_FILE}"
    xmlstarlet ed --inplace --update "/style-scheme/@_name"       --value "GCS theme"                   "${MELD_DESTINATION_STYLE_FILE}"
    xmlstarlet ed --inplace --update "/style-scheme/author"       --value "GCS - Global Color Scheme"   "${MELD_DESTINATION_STYLE_FILE}"
    xmlstarlet ed --inplace --update "/style-scheme/_description" --value "Theme auto-generated by GCS" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_insert_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@foreground"      --value "${meld_insert_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_insert_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@background"      --value "${meld_insert_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_insert_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@line-background" --value "${meld_insert_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_replace_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:replace']/@foreground"      --value "${meld_replace_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_replace_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:replace']/@background"      --value "${meld_replace_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_replace_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:replace']/@line-background" --value "${meld_replace_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_conflict_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:conflict']/@foreground"      --value "${meld_conflict_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_conflict_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:conflict']/@background"      --value "${meld_conflict_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_conflict_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:conflict']/@line-background" --value "${meld_conflict_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_delete_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:delete']/@foreground"      --value "${meld_delete_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_delete_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:delete']/@background"      --value "${meld_delete_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_delete_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:delete']/@line-background" --value "${meld_delete_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_error_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:error']/@foreground"      --value "${meld_error_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_error_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:error']/@background"      --value "${meld_error_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_error_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:error']/@line-background" --value "${meld_error_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_insert_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@foreground"      --value "${meld_insert_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_insert_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@background"      --value "${meld_insert_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_insert_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@line-background" --value "${meld_insert_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_insert_text}"    != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@foreground"      --value "${meld_insert_text}"    "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_insert_bg}"      != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@background"      --value "${meld_insert_bg}"      "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_insert_outline}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:insert']/@line-background" --value "${meld_insert_outline}" "${MELD_DESTINATION_STYLE_FILE}"
    
    [ "${meld_inline_bg}"               != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:inline']/@background"                  --value "${meld_inline_bg}"               "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_current_line_highlight}"  != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:current-line-highlight']/@background"  --value "${meld_current_line_highlight}"  "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_unknown_text}"            != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:unknown-text']/@foreground"            --value "${meld_unknown_text}"            "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_current_line_highlight}"  != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:current-line-highlight']/@background"  --value "${meld_current_line_highlight}"  "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_syncpoint_outline}"       != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:syncpoint-outline']/@background"       --value "${meld_syncpoint_outline}"       "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_current_chunk_highlight}" != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:current-chunk-highlight']/@background" --value "${meld_current_chunk_highlight}" "${MELD_DESTINATION_STYLE_FILE}"
    [ "${meld_current_dimmed}"          != "" ] && xmlstarlet ed --inplace --update "/style-scheme/style[@name='meld:dimmed']/@background"                  --value "${meld_current_dimmed}"          "${MELD_DESTINATION_STYLE_FILE}"
    
    gsettings set org.gnome.meld style-scheme "gcs-theme"
    
    printf " done.\n"
fi

