#!/bin/bash

# TODO: handle cases when $wallpaper_image, $wallpaper_mode or $wallpaper_bg_color is not set by the theme

which nautilus >/dev/null || return
which gsettings >/dev/null || return
which ps >/dev/null || return

BACKGROUND_NAUTILUS_ENABLE_DEFAULT="true"
BACKGROUND_NAUTILUS_ENABLE="$(crudini --get ${GCS_CONFIG_FILE} background-nautilus enable 2>/dev/null || echo "${BACKGROUND_NAUTILUS_ENABLE_DEFAULT}")"

for i in ${COLOR_THEME_DIRS[@]}; do
    if [ -f "$i/${wallpaper_image}" ]; then
        wallpaper_file="$i/${wallpaper_image}"
    fi
done

if ! [ "${BACKGROUND_NAUTILUS_ENABLE}" == "true" ]; then
    printf "* Ignoring wallpaper for nautilus (disabled from configuration).\n"

elif [ "${GCS_ACTION}" == "create-backup" ]; then
    printf "* Making backup of wallpaper for nautilus..."

    BACKGROUND_NAUTILUS_BACKUP_DIR="${GCS_BACKUPS_DIR}/${GCS_BACKUP_NAME}/background-nautilus"
    mkdir -p "${BACKGROUND_NAUTILUS_BACKUP_DIR}"

    gsettings get org.gnome.desktop.background color-shading-type > "${BACKGROUND_NAUTILUS_BACKUP_DIR}/color-shading-type"
    gsettings get org.gnome.desktop.background picture-opacity    > "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-opacity"
    gsettings get org.gnome.desktop.background primary-color      > "${BACKGROUND_NAUTILUS_BACKUP_DIR}/primary-color"
    gsettings get org.gnome.desktop.background secondary-color    > "${BACKGROUND_NAUTILUS_BACKUP_DIR}/secondary-color"
    gsettings get org.gnome.desktop.background picture-uri        > "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-uri"
    gsettings get org.gnome.desktop.background picture-options    > "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-options"

    printf " done.\n"

elif [ "${GCS_ACTION}" == "restore-backup" ]; then
    printf "* Restoring backup of wallpaper for nautilus..."

    BACKGROUND_NAUTILUS_BACKUP_DIR="${GCS_BACKUPS_DIR}/${GCS_BACKUP_NAME}/background-nautilus"

    if [ -f "${BACKGROUND_NAUTILUS_BACKUP_DIR}/color-shading-type" ]; then
        gsettings set org.gnome.desktop.background color-shading-type $(cat "${BACKGROUND_NAUTILUS_BACKUP_DIR}/color-shading-type")
    fi

    if [ -f "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-opacity" ]; then
        gsettings set org.gnome.desktop.background picture-opacity    $(cat "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-opacity")
    fi

    if [ -f "${BACKGROUND_NAUTILUS_BACKUP_DIR}/primary-color" ]; then
        gsettings set org.gnome.desktop.background primary-color      $(cat "${BACKGROUND_NAUTILUS_BACKUP_DIR}/primary-color")
    fi

    if [ -f "${BACKGROUND_NAUTILUS_BACKUP_DIR}/secondary-color" ]; then
        gsettings set org.gnome.desktop.background secondary-color    $(cat "${BACKGROUND_NAUTILUS_BACKUP_DIR}/secondary-color")
    fi

    if [ -f "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-uri" ]; then
        gsettings set org.gnome.desktop.background picture-uri        $(cat "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-uri")
    fi

    if [ -f "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-options" ]; then
        gsettings set org.gnome.desktop.background picture-options    $(cat "${BACKGROUND_NAUTILUS_BACKUP_DIR}/picture-options")
    fi

    printf " done.\n"

elif [ "${GCS_ACTION}" == "apply-theme" ]; then
    if ! [ -f "${wallpaper_file}" ]; then
        printf "* Not setting wallpaper with nautilus (image file not found: \"${wallpaper_image}\").\n"

    elif ! pgrep "nautilus" >/dev/null; then
        printf "* Not setting wallpaper with nautilus (desktop manager is not active).\n"

    else
        printf "* Setting wallpaper with nautilus..."

        gsettings set org.gnome.desktop.background color-shading-type "solid"
        gsettings set org.gnome.desktop.background primary-color "${wallpaper_bg_color}"

        case "${wallpaper_mode}" in
            centered)  gsettings set org.gnome.desktop.background picture-uri "file://${wallpaper_file}"
                       gsettings set org.gnome.desktop.background picture-options "centered";;
            tiled)     gsettings set org.gnome.desktop.background picture-uri "file://${wallpaper_file}"
                       gsettings set org.gnome.desktop.background picture-options "spanned";;
            stretched) gsettings set org.gnome.desktop.background picture-uri "file://${wallpaper_file}"
                       gsettings set org.gnome.desktop.background picture-options "stretched";;
            zoom-fit)  gsettings set org.gnome.desktop.background picture-uri "file://${wallpaper_file}"
                       gsettings set org.gnome.desktop.background picture-options "scaled";;
            zoom-fill) gsettings set org.gnome.desktop.background picture-uri "file://${wallpaper_file}"
                       gsettings set org.gnome.desktop.background picture-options "zoom";;
        esac
        printf " done.\n"

    fi

fi

