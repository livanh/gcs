#!/bin/bash

which cherrytree >/dev/null || return

: ${cherrytree_window_fg:=${text_color}}
: ${cherrytree_window_bg:=${base_color}}
: ${cherrytree_tree_fg:=${text_color}}
: ${cherrytree_tree_bg:=${base_color}}
: ${cherrytree_link_web:=${link_color}}
: ${cherrytree_link_node:=${link_color}}
: ${cherrytree_link_file:=${link_color}}
: ${cherrytree_link_directory:=${link_color}}

CHERRYTREE_ENABLE_DEFAULT="true"
CHERRYTREE_CONFIG_FILE_DEFAULT="$HOME/.config/cherrytree/config.cfg"

CHERRYTREE_ENABLE="$(crudini      --get ${GCS_CONFIG_FILE} cherrytree enable      2>/dev/null || echo "${CHERRYTREE_ENABLE_DEFAULT}")"
CHERRYTREE_CONFIG_FILE="$(crudini --get ${GCS_CONFIG_FILE} cherrytree config_file 2>/dev/null || echo "${CHERRYTREE_CONFIG_FILE_DEFAULT}")"

if ! [ "${CHERRYTREE_ENABLE}" == "true" ]; then
    printf "* Ignoring cherrytree (disabled from configuration).\n"

elif ! [ -f "${CHERRYTREE_CONFIG_FILE}" ]; then
    printf "* Ignoring cherrytree (configuration file ${CHERRYTREE_CONFIG_FILE} not found).\n"

elif [ "${GCS_ACTION}" == "create-backup" ]; then
    printf "* Making backup of cherrytree configuration file..."

    CHERRYTREE_BACKUP_DIR="${GCS_BACKUPS_DIR}/${GCS_BACKUP_NAME}/cherrytree"
    mkdir -p "${CHERRYTREE_BACKUP_DIR}"
    cp "${CHERRYTREE_CONFIG_FILE}" "${CHERRYTREE_BACKUP_DIR}/config.cfg"

    printf " done.\n"

elif [ "${GCS_ACTION}" == "restore-backup" ]; then
    printf "* Restoring backup of cherrytree configuration file..."

    CHERRYTREE_BACKUP_DIR="${GCS_BACKUPS_DIR}/${GCS_BACKUP_NAME}/cherrytree"
    if [ -f "${CHERRYTREE_BACKUP_DIR}/config.cfg" ]; then 
        cp "${CHERRYTREE_BACKUP_DIR}/config.cfg" "${CHERRYTREE_CONFIG_FILE}"
        printf " done.\n"
    else
        printf " not found!\n"
    fi

elif [ "${GCS_ACTION}" == "apply-theme" ]; then
    printf "* Setting colors for cherrytree..."

    CHERRYTREE_TMP_DIR="${GCS_TMP_DIR}/cherrytree"
    CHERRYTREE_TMP_CONFIG_FILE="${CHERRYTREE_TMP_DIR}/config.cfg"
    mkdir "${CHERRYTREE_TMP_DIR}"
    cp "${CHERRYTREE_CONFIG_FILE}" "${CHERRYTREE_TMP_CONFIG_FILE}"

    set_value "rt_def_fg"     " = " "${cherrytree_window_fg}"      "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "rt_def_bg"     " = " "${cherrytree_window_bg}"      "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "tt_def_fg"     " = " "${cherrytree_tree_fg}"        "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "tt_def_bg"     " = " "${cherrytree_tree_bg}"        "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "col_link_webs" " = " "${cherrytree_link_web}"       "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "col_link_node" " = " "${cherrytree_link_node}"      "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "col_link_file" " = " "${cherrytree_link_file}"      "${CHERRYTREE_TMP_CONFIG_FILE}"
    set_value "col_link_fold" " = " "${cherrytree_link_directory}" "${CHERRYTREE_TMP_CONFIG_FILE}"

    mv "${CHERRYTREE_TMP_CONFIG_FILE}" "${CHERRYTREE_CONFIG_FILE}"

    printf " done.\n"
fi

