#!/bin/bash
# TODO: handle cases when $wallpaper_image, $wallpaper_mode or $wallpaper_bg_color is not set by the theme

function pcmanfm_init_module() {
    BACKGROUND_PCMANFM_ENABLE_DEFAULT="true"
    BACKGROUND_PCMANFM_ENABLE="$(crudini --get ${GCS_CONFIG_FILE} background-pcmanfm enable 2>/dev/null || echo "${BACKGROUND_PCMANFM_ENABLE_DEFAULT}")"
}



function pcmanfm_check_dependencies() {
    if ! which pcmanfm >/dev/null; then
        return 1

    elif ! which pgrep >/dev/null; then
        return 1

    elif ! [ "${BACKGROUND_PCMANFM_ENABLE}" == "true" ]; then
        printf "* Ignoring wallpaper for pcmanfm (disabled from configuration).\n"
        return 1

    else
        return 0

    fi

}



function pcmanfm_derive_colors() {
    for i in ${COLOR_THEME_DIRS[@]}; do
        if [ -f "$i/${wallpaper_image}" ]; then
            wallpaper_file="$i/${wallpaper_image}"
        fi
    done
}



function pcmanfm_create_backup() {
    printf "* Backup/restore not supported with pcmanfm wallpaper.\n"
}



function pcmanfm_restore_backup() {
    printf "* Backup/restore not supported with pcmanfm wallpaper.\n"
}



function pcmanfm_apply_theme() {
    if ! [ -f "${wallpaper_file}" ]; then
        printf "* Not setting wallpaper with pcmanfm (image file not found: \"${wallpaper_image}\").\n"

    elif ! pgrep -f "pcmanfm --desktop" >/dev/null; then
        printf "* Not setting wallpaper with pcmanfm (desktop manager is not active).\n"

    else
        printf "* Setting wallpaper with pcmanfm..."

        case "${wallpaper_mode}" in
            centered)  pcmanfm --wallpaper-mode=center  --set-wallpaper "${wallpaper_file}";;
            tiled)     pcmanfm --wallpaper-mode=tile    --set-wallpaper "${wallpaper_file}";;
            stretched) pcmanfm --wallpaper-mode=stretch --set-wallpaper "${wallpaper_file}";;
            zoom-fit)  pcmanfm --wallpaper-mode=fit     --set-wallpaper "${wallpaper_file}";;
            zoom-fill) pcmanfm --wallpaper-mode=crop    --set-wallpaper "${wallpaper_file}";;
        esac

        # these require a patched version of PCManFM: https://github.com/livanh/pcmanfm (master-with-improvements branch)
        pcmanfm --wallpaper-bg-color ${wallpaper_bg_color}
        pcmanfm --desktop-text-color ${wallpaper_text_color}
        pcmanfm --desktop-shadow-color ${wallpaper_shadow_color}

        printf " done.\n"

    fi
}



pcmanfm_init_module
pcmanfm_check_dependencies
[ $? == 1 ] && return

if [ "${GCS_ACTION}" == "create-backup" ]; then
    pcmanfm_create_backup

elif [ "${GCS_ACTION}" == "restore-backup" ]; then
    pcmanfm_restore_backup

elif [ "${GCS_ACTION}" == "apply-theme" ]; then
    pcmanfm_derive_colors
    pcmanfm_apply_theme

fi

