#!/bin/bash

# TODO: handle cases when $wallpaper_image, $wallpaper_mode or $wallpaper_bg_color is not set by the theme

which pcmanfm >/dev/null || return

BACKGROUND_PCMANFM_ENABLE_DEFAULT="true"
BACKGROUND_PCMANFM_ENABLE="$(crudini --get ${CONFIG_FILE} background-pcmanfm enable 2>/dev/null || echo "${BACKGROUND_PCMANFM_ENABLE_DEFAULT}")"

for i in ${COLOR_THEME_DIRS[@]}; do
    if [ -f "$i/${wallpaper_image}" ]; then
        wallpaper_file="$i/${wallpaper_image}"
    fi
done

if ! [ "${BACKGROUND_PCMANFM_ENABLE}" == "true" ]; then
    printf "* Not setting wallpaper with pcmanfm (disabled from configuration).\n"
    
elif ! [ -f "${wallpaper_file}" ]; then
    printf "* Not setting wallpaper with pcmanfm (image file not found: \"${wallpaper_image}\").\n"
    
elif ! pgrep -f "pcmanfm --desktop" >/dev/null; then
    printf "* Not setting wallpaper with pcmanfm (desktop manager is not active).\n"
    
else
    printf "* Setting wallpaper with pcmanfm..."
    
    case "${wallpaper_mode}" in
        centered)  pcmanfm --wallpaper-mode=center  --set-wallpaper "${wallpaper_file}";;
        tiled)     pcmanfm --wallpaper-mode=tile    --set-wallpaper "${wallpaper_file}";;
        stretched) pcmanfm --wallpaper-mode=stretch --set-wallpaper "${wallpaper_file}";;
        zoom-fit)  pcmanfm --wallpaper-mode=fit     --set-wallpaper "${wallpaper_file}";;
        zoom-fill) pcmanfm --wallpaper-mode=crop    --set-wallpaper "${wallpaper_file}";;
    esac

    # these require a patched version of PCManFM: https://github.com/livanh/pcmanfm (master-with improvements branch)
    pcmanfm --wallpaper-bg-color ${wallpaper_bg_color}
    pcmanfm --desktop-text-color ${wallpaper_text_color}
    pcmanfm --desktop-shadow-color ${wallpaper_shadow_color}

    printf " done.\n"
fi
