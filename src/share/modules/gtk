#!/bin/bash

: ${gtk_base_color:=${base_color}}
: ${gtk_text_color:=${text_color}}
: ${gtk_bg_color:=${bg_color}}
: ${gtk_fg_color:=${fg_color}}
: ${gtk_menu_bg_color:=${bg_color}}
: ${gtk_menu_fg_color:=${fg_color}}
: ${gtk_selected_bg_color:=${selected_bg_color}}
: ${gtk_selected_fg_color:=${selected_fg_color}}
: ${gtk_button_bg_color:=${bg_color}}
: ${gtk_button_fg_color:=${fg_color}}
: ${gtk_header_button_bg_color:=${bg_color}}
: ${gtk_header_button_fg_color:=${fg_color}}

gtk_roundness=$(crudini --get ${CONFIG_FILE} gtk roundness 2>/dev/null || echo 3)
gtk_spacing=$(crudini   --get ${CONFIG_FILE} gtk spacing   2>/dev/null || echo 3)
gtk_gradient=$(crudini  --get ${CONFIG_FILE} gtk gradient  2>/dev/null || echo 0.14)

GTK_ENABLE_DEFAULT="true"
GTK_ENABLE="$(crudini --get ${CONFIG_FILE} gtk enable 2>/dev/null || echo "${GTK_ENABLE_DEFAULT}")"

if ! [ "${GTK_ENABLE}" == "true" ]; then
    printf "* Not setting colors and icon theme for GTK+ (disabled from configuration).\n"

elif ! which oomox-cli >/dev/null; then 
    printf "* Not setting colors and icon theme for GTK+ (oomox not installed).\n"

else
    printf "* Setting colors and icon theme for GTK+...\n"

    TMPFILE="/tmp/.oomox-theme"

    echo "NAME=gcs-theme" > "${TMPFILE}"
    echo "BG=${gtk_bg_color:1}" >> "${TMPFILE}"
    echo "FG=${gtk_fg_color:1}" >> "${TMPFILE}"
    echo "MENU_BG=${gtk_menu_bg_color:1}" >> "${TMPFILE}"
    echo "MENU_FG=${gtk_menu_fg_color:1}" >> "${TMPFILE}"
    echo "SEL_BG=${gtk_selected_bg_color:1}" >> "${TMPFILE}"
    echo "SEL_FG=${gtk_selected_fg_color:1}" >> "${TMPFILE}"
    echo "TXT_BG=${gtk_base_color:1}" >> "${TMPFILE}"
    echo "TXT_FG=${gtk_text_color:1}" >> "${TMPFILE}"
    echo "BTN_BG=${gtk_button_bg_color:1}" >> "${TMPFILE}"
    echo "BTN_FG=${gtk_button_fg_color:1}" >> "${TMPFILE}"
    echo "HDR_BTN_BG=${gtk_header_button_bg_color:1}" >> "${TMPFILE}"
    echo "HDR_BTN_FG=${gtk_header_button_fg_color:1}" >> "${TMPFILE}"
    echo "GTK3_GENERATE_DARK=False" >> "${TMPFILE}"
    echo "ROUNDNESS=${gtk_roundness}" >> "${TMPFILE}"
    echo "SPACING=${gtk_spacing}" >> "${TMPFILE}"
    echo "GRADIENT=${gtk_gradient}" >> "${TMPFILE}"

    oomox-cli -o gcs-theme "${TMPFILE}" >/dev/null 2>/dev/null
    rm "${TMPFILE}"

    icon_theme_found="false"
    if ! [ -z "${icon_theme_name}" ]; then
        for i in "/usr/share/icons" "usr/local/share/icons" "$HOME/.icons" "$HOME/.local/share/icons"; do
            if [ -d "$i/$icon_theme_name" ]; then
                icon_theme_found="true"
            fi
        done
    fi

    if ps -e | grep xsettings >/dev/null; then

        GTK_XSETTINGSD_RESTART_COMMAND=$(crudini --get ${CONFIG_FILE} gtk xsettingsd_restart_command 2>/dev/null || echo )
        GTK_XSETTINGSD_CONFIG_FILE=$(crudini --get ${CONFIG_FILE} gtk xsettingsd_config_file 2>/dev/null || echo "$HOME/.xsettingsd")

        printf "  colors..."
        set_value "Net\/ThemeName" " " "\"gcs-theme\"" "${GTK_XSETTINGSD_CONFIG_FILE}"
        printf " done.\n"

        if ! [ -z "${icon_theme_name}" ]; then
            printf "  icon theme: ${icon_theme_name}..."
            if [ "${icon_theme_found}" == "true" ]; then
                set_value "Net\/IconThemeName" " " "\"${icon_theme_name}\"" "${GTK_XSETTINGSD_CONFIG_FILE}"
                printf " done.\n"
            else
                printf " not found!\n"
            fi
        fi

        $GTK_XSETTINGSD_RESTART_COMMAND &>/dev/null


    elif ps -e | grep gnome-session >/dev/null; then

        printf "  colors..."
        gsettings set org.gnome.desktop.interface gtk-theme ""
        gsettings set org.gnome.desktop.interface gtk-theme "gcs-theme"
        gsettings set org.gnome.desktop.interface gtk-color-scheme ""
        printf " done.\n"

        if ! [ -z "${icon_theme_name}" ]; then
            printf "  icon theme: ${icon_theme_name}..."
            if [ "${icon_theme_found}" == "true" ]; then
                gsettings set org.gnome.desktop.interface icon-theme "${icon_theme_name}"
                printf " done.\n"
            else
                printf " not found!\n"
            fi
        fi

        printf " done.\n"

    else
        printf " no supported XSettings manager found!\n"
        # TODO: configure theme/colors with .gtkrc-2.0 and .config/gtk-3.0/settings.ini
    fi

fi
