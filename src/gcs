#!/bin/bash

# GCS - Global Color Scheme
#
# Copyright (C) 2015 Livanh <livanh@bulletmail.org>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# TODO: enable or disable modules with a config file
# TODO: create per-module configuration in config files
# TODO: look for modules and themes in both system and user-specific directories
# TODO: show a list of available color schemes when running without arguments 

MODULES_DIR="$HOME/.local/share/gcs/modules"
CONFIG_DIR="$HOME/.config/gcs"
THEMES_DIR="$HOME/.config/gcs/colorthemes"

if [ "$#" -ne 1 ]; then
    echo Usage: $0 \<color theme name\>
    exit 1
fi
COLOR_THEME="$1"


# set the value of the key named $KEY (in text file $FILE) equal to $VALUE
# assuming they are separated by $SEPARATOR
# warning: do not use for config file with different sections, because
# if the key does not exist, it will be created at the end of the file
set_value() {
    if [ "$#" -ne 4 ]; then
	echo "Error: set_value() requires 4 arguments!"
	exit 2
    fi
    local KEY=$1
    local SEPARATOR=$2
    local VALUE=$3
    local FILE=$4
    if grep -E "^([[:space:]]*|(.*[[:space:]]+))*${KEY}${SEPARATOR}.*" "${FILE}" >/dev/null; then
	sed -r -i "s/^([[:space:]]*|(.*[[:space:]]+))*${KEY}${SEPARATOR}.*/$(grep -E "^([[:space:]]*|(.*[[:space:]]+))*${KEY}" "${FILE}" | sed "s/${KEY}.*//")${KEY}${SEPARATOR}${VALUE}/" "${FILE}"
    else
	echo "${KEY}${SEPARATOR}${VALUE}" >>"${FILE}"
    fi
}

# set the value of the key named $KEY (in section [section] on text
# file $FILE) equal to $VALUE, assuming they are separated by $SEPARATOR
# TODO: define behaviour when $SECTION is not found
set_value_section() {
    if [ "$#" -ne 5 ]; then
	echo "Error: set_value_section() requires 5 arguments!"
	exit 2
    fi
    local SECTION=$1
    local KEY=$2
    local SEPARATOR=$3
    local VALUE=$4
    local FILE=$5
    local old_section=$(grep -Pzo "\[${SECTION}\](.|\n)*?\[" "${FILE}")
    local tmp_file="$(mktemp)"
    echo "$old_section" >"$tmp_file"
    set_value "$KEY" "$SEPARATOR" "$VALUE" "$tmp_file"
    perl -i -p0e "s/\Q${old_section}\E/$(cat $tmp_file)/" ${FILE}
    rm $tmp_file
}


if [ -f "${THEMES_DIR}/${COLOR_THEME}/colortheme" ]; then
    echo "Applying color theme ${COLOR_THEME}"
    echo
    # main loop invokes all available modules
    for i in "${MODULES_DIR}/"*; do
	if [ -x "$i" ]; then
	    . "${THEMES_DIR}/${COLOR_THEME}/colortheme"
	    . "$i"
	    echo
	fi
    done
else
    echo Error: theme ${COLOR_THEME} not found!
    exit 2
fi
